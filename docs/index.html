<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARIN IPv4 Waitlist Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --card-bg: white;
            --text-color: #333;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
            --error-bg: #ffebee;
            --error-color: #d32f2f;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --card-bg: #2d2d2d;
                --text-color: #e0e0e0;
                --text-muted: #a0a0a0;
                --border-color: #404040;
                --shadow: 0 2px 4px rgba(0,0,0,0.3);
                --error-bg: #3d1a1a;
                --error-color: #ff6b6b;
            }
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-container {
            background-color: var(--card-bg);
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-muted);
        }
        .error {
            text-align: center;
            padding: 50px;
            color: var(--error-color);
            background-color: var(--error-bg);
            border-radius: 8px;
            margin: 20px 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .footer {
            text-align: center;
            margin: 40px 0 20px 0;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 14px;
            transition: border-color 0.3s ease, color 0.3s ease;
        }
        .footer a {
            color: #007bff;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .last-updated {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-muted);
            font-style: italic;
        }
        .last-updated-label {
            font-weight: 600;
        }
        .last-updated-time {
            font-weight: normal;
        }
        .statistics-section {
            margin: 30px 0;
        }
        .statistics-section h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card h3 {
            margin: 0 0 15px 0;
            color: var(--text-color);
            font-size: 18px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
        }
        .stat-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        .stat-label {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
        }
        .stat-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 15px;
        }
        .trend-up {
            color: #ff6b6b;
        }
        .trend-down {
            color: #4ecdc4;
        }
        .trend-stable {
            color: var(--text-muted);
        }
        .trend-indicator {
            margin-left: 5px;
            font-size: 12px;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .stat-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ARIN IPv4 Waitlist Dashboard</h1>
        <p>Real-time analysis of IPv4 address block waitlist and estimated wait times</p>
        <p class="last-updated" id="lastUpdated" style="display: none;">
            <span class="last-updated-label">Last Updated:</span>
            <span class="last-updated-time" id="lastUpdatedTime"></span>
        </p>
    </div>

    <div id="statistics" class="statistics-section" style="display: none;">
        <h2>Current Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Current Waitlist</h3>
                <div class="stat-item">
                    <span class="stat-label">/22 requests:</span>
                    <span class="stat-value" id="current-22">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/23 requests:</span>
                    <span class="stat-value" id="current-23">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/24 requests:</span>
                    <span class="stat-value" id="current-24">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total requests:</span>
                    <span class="stat-value" id="total-requests">-</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Estimated Wait Times</h3>
                <div class="stat-item">
                    <span class="stat-label">/22 networks:</span>
                    <span class="stat-value" id="wait-22">- years</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/23 networks:</span>
                    <span class="stat-value" id="wait-23">- years</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/24 networks:</span>
                    <span class="stat-value" id="wait-24">- years</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Average wait:</span>
                    <span class="stat-value" id="avg-wait">- years</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Clearing Rates</h3>
                <div class="stat-item">
                    <span class="stat-label">/22 per quarter:</span>
                    <span class="stat-value" id="cleared-22">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/23 per quarter:</span>
                    <span class="stat-value" id="cleared-23">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/24 per quarter:</span>
                    <span class="stat-value" id="cleared-24">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total per quarter:</span>
                    <span class="stat-value" id="total-cleared">-</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Network Analysis</h3>
                <div class="stat-item">
                    <span class="stat-label">Total /24 equivalent:</span>
                    <span class="stat-value" id="total-24-equiv">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">IPv4 addresses waiting:</span>
                    <span class="stat-value" id="total-ips">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Most efficient block:</span>
                    <span class="stat-value" id="most-efficient">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Least efficient block:</span>
                    <span class="stat-value" id="least-efficient">-</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Market Share by Block Size</h3>
                <div class="stat-item">
                    <span class="stat-label">/22 blocks (by requests):</span>
                    <span class="stat-value" id="market-22-requests">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/23 blocks (by requests):</span>
                    <span class="stat-value" id="market-23-requests">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">/24 blocks (by requests):</span>
                    <span class="stat-value" id="market-24-requests">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Largest block demand:</span>
                    <span class="stat-value" id="largest-demand">-</span>
                </div>
            </div>

            <div class="stat-card">
                <h3>Historical Context</h3>
                <div class="stat-item">
                    <span class="stat-label">Total requests:</span>
                    <span class="stat-value" id="total-trend">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Peak total requests:</span>
                    <span class="stat-value" id="peak-total">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Net change rate:</span>
                    <span class="stat-value" id="net-change">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Clearing efficiency:</span>
                    <span class="stat-value" id="clearing-efficiency">-</span>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <h3>Loading data...</h3>
    </div>

    <div id="error" class="error" style="display: none;">
        <h3>Error loading data</h3>
        <p>Could not load waitlist_data.csv. Please ensure the file exists in the same directory.</p>
    </div>

    <div id="charts" style="display: none;">
        <div class="chart-container">
            <h2>Current Waitlist Size</h2>
            <div class="chart-wrapper">
                <canvas id="waitlistChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>Historical Blocks Cleared Per Quarter</h2>
            <div class="chart-wrapper">
                <canvas id="historicalChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>Estimated Wait Time (Years)</h2>
            <div class="chart-wrapper">
                <canvas id="waitTimeChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>Total Processing Capacity Over Time</h2>
            <div class="chart-wrapper">
                <canvas id="processedChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuration for chart colors
        const colors = {
            '/22': '#ff6384',
            '/23': '#36a2eb',
            '/24': '#4bc0c0'
        };

        // Function to parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;

                const values = line.split(',').map(v => v.trim());
                if (values.length !== headers.length) continue; // Skip malformed rows

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }

            // Sort data by timestamp to ensure proper chronological order
            data.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return dateA - dateB;
            });

            console.log('Parsed and sorted data:', data); // Debug output
            return data;
        }

        // Function to create chart datasets
        function createDatasets(data, valueColumns, label) {
            const datasets = [];

            Object.keys(colors).forEach(size => {
                const column = valueColumns[size];
                if (column) {
                    const chartData = data.map(row => {
                        const value = parseFloat(row[column]);
                        console.log(`${column} for ${size}: "${row[column]}" -> ${value}`); // Debug output
                        return {
                            x: new Date(row.timestamp),
                            y: isNaN(value) ? 0 : value
                        };
                    });

                    datasets.push({
                        label: `${label} ${size}`,
                        data: chartData,
                        borderColor: colors[size],
                        backgroundColor: colors[size] + '20',
                        tension: 0.1
                    });
                }
            });

            return datasets;
        }

        // Function to get current theme colors
        function getThemeColors() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            return {
                text: isDark ? '#e0e0e0' : '#333',
                grid: isDark ? '#404040' : '#dee2e6'
            };
        }

        // Function to create a chart
        function createChart(canvasId, title, data, valueColumns, yAxisLabel) {
            try {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const datasets = createDatasets(data, valueColumns, '');
                const themeColors = getThemeColors();

                return new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            color: themeColors.text
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: themeColors.text
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd, yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time',
                                color: themeColors.text
                            },
                            ticks: {
                                color: themeColors.text
                            },
                            grid: {
                                color: themeColors.grid
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: themeColors.text
                            },
                            ticks: {
                                color: themeColors.text
                            },
                            grid: {
                                color: themeColors.grid
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error(`Error creating chart ${canvasId}:`, error);
                throw error;
            }
        }

        // Function to create processing capacity chart
        function createProcessingChart(canvasId, title, data) {
            try {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const themeColors = getThemeColors();

                // Calculate total processing capacity and individual components
                const datasets = [];

                // Individual block type datasets
                Object.keys(colors).forEach(size => {
                    const column = {
                        '/22': 'avg_22_cleared_per_quarter',
                        '/23': 'avg_23_cleared_per_quarter',
                        '/24': 'avg_24_cleared_per_quarter'
                    }[size];

                    if (column) {
                        const chartData = data.map(row => {
                            const value = parseFloat(row[column]) || 0;
                            return {
                                x: new Date(row.timestamp),
                                y: value
                            };
                        });

                        datasets.push({
                            label: `${size} Blocks`,
                            data: chartData,
                            borderColor: colors[size],
                            backgroundColor: colors[size] + '20',
                            tension: 0.1
                        });
                    }
                });

                // Total processing capacity dataset
                const totalData = data.map(row => {
                    const cleared22 = parseFloat(row.avg_22_cleared_per_quarter) || 0;
                    const cleared23 = parseFloat(row.avg_23_cleared_per_quarter) || 0;
                    const cleared24 = parseFloat(row.avg_24_cleared_per_quarter) || 0;
                    const total = cleared22 + cleared23 + cleared24;

                    return {
                        x: new Date(row.timestamp),
                        y: total
                    };
                });

                datasets.push({
                    label: 'Total Capacity',
                    data: totalData,
                    borderColor: '#ffa500',
                    backgroundColor: '#ffa500' + '20',
                    borderWidth: 3,
                    tension: 0.1
                });

                return new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                color: themeColors.text
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: themeColors.text
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    displayFormats: {
                                        day: 'MMM dd, yyyy'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time',
                                    color: themeColors.text
                                },
                                ticks: {
                                    color: themeColors.text
                                },
                                grid: {
                                    color: themeColors.grid
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Entries Processed Per Quarter',
                                    color: themeColors.text
                                },
                                ticks: {
                                    color: themeColors.text
                                },
                                grid: {
                                    color: themeColors.grid
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating processing chart ${canvasId}:`, error);
                throw error;
            }
        }

        // Function to format numbers with commas
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return parseFloat(num).toLocaleString();
        }

        // Function to format years with 1 decimal place
        function formatYears(years) {
            if (years === null || years === undefined || isNaN(years)) return '-';
            if (years === Infinity) return '‚àû';
            return parseFloat(years).toFixed(1);
        }

        // Function to format percentages
        function formatPercentage(value, total) {
            if (total === 0 || isNaN(value) || isNaN(total)) return '0.0%';
            return ((value / total) * 100).toFixed(1) + '%';
        }

        // Function to calculate trend indicator
        function getTrendIndicator(current, previous, reverse = false) {
            if (previous === null || previous === undefined || current === previous) {
                return '<span class="trend-indicator trend-stable">‚óè</span>';
            }
            const isUp = current > previous;
            const trend = reverse ? !isUp : isUp;
            const arrow = trend ? '‚Üó' : '‚Üò';
            const className = trend ? 'trend-up' : 'trend-down';
            return `<span class="trend-indicator ${className}">${arrow}</span>`;
        }

        // Function to calculate block efficiency (IPs per year wait time)
        function calculateBlockEfficiency(ips, waitYears) {
            if (waitYears === 0 || waitYears === Infinity) return 0;
            return ips / waitYears;
        }

        // Function to calculate and display statistics
        function updateStatistics(data) {
            if (data.length === 0) return;

            try {
                // Get the most recent data point and previous for trends
                const latest = data[data.length - 1];
                const previous = data.length > 1 ? data[data.length - 2] : null;

                // Current waitlist counts
                const req22 = parseInt(latest.requests_22) || 0;
                const req23 = parseInt(latest.requests_23) || 0;
                const req24 = parseInt(latest.requests_24) || 0;
                const totalReq = parseInt(latest.total_requests) || 0;

                // Wait times
                const wait22 = parseFloat(latest.estimated_years_22) || 0;
                const wait23 = parseFloat(latest.estimated_years_23) || 0;
                const wait24 = parseFloat(latest.estimated_years_24) || 0;

                // Clearing rates
                const cleared22 = parseFloat(latest.avg_22_cleared_per_quarter) || 0;
                const cleared23 = parseFloat(latest.avg_23_cleared_per_quarter) || 0;
                const cleared24 = parseFloat(latest.avg_24_cleared_per_quarter) || 0;

                // Calculated statistics
                const total24Equiv = (req22 * 4) + (req23 * 2) + req24;
                const totalIPs = (req22 * 1024) + (req23 * 512) + (req24 * 256);
                const totalCleared = cleared22 + cleared23 + cleared24;

                // Weighted average wait time
                const totalRequests = req22 + req23 + req24;
                const avgWait = totalRequests > 0 ?
                    ((wait22 * req22) + (wait23 * req23) + (wait24 * req24)) / totalRequests : 0;

                // Block efficiency calculations (IPs per year)
                const eff22 = calculateBlockEfficiency(1024, wait22);
                const eff23 = calculateBlockEfficiency(512, wait23);
                const eff24 = calculateBlockEfficiency(256, wait24);

                const efficiencies = [
                    { type: '/22', efficiency: eff22, ips: 1024 },
                    { type: '/23', efficiency: eff23, ips: 512 },
                    { type: '/24', efficiency: eff24, ips: 256 }
                ].filter(e => e.efficiency > 0).sort((a, b) => b.efficiency - a.efficiency);

                const mostEfficient = efficiencies[0];
                const leastEfficient = efficiencies[efficiencies.length - 1];

                // Historical analysis
                const allTotals = data.map(d => parseInt(d.total_requests) || 0);
                const peakTotal = Math.max(...allTotals);
                const minTotal = Math.min(...allTotals);

                // Net change rate calculation (requests per time period)
                let netChangeRate = 0;
                let changeText = 'No data';
                if (data.length >= 2) {
                    const oldestTotal = parseInt(data[0].total_requests) || 0;
                    const latestTotal = parseInt(latest.total_requests) || 0;
                    const totalChange = latestTotal - oldestTotal;

                    // Calculate time span in years
                    const oldestDate = new Date(data[0].timestamp);
                    const latestDate = new Date(latest.timestamp);
                    const yearsSpan = (latestDate - oldestDate) / (1000 * 60 * 60 * 24 * 365.25);

                    if (yearsSpan > 0) {
                        netChangeRate = totalChange / yearsSpan;
                        const sign = netChangeRate >= 0 ? '+' : '';
                        changeText = `${sign}${Math.round(netChangeRate)} req/year`;
                    }
                }

                // Clearing efficiency ratio (how well clearing keeps up with demand)
                const totalClearedPerYear = totalCleared * 4; // quarters to years
                let efficiencyRatio = 'No trend data';
                if (netChangeRate !== 0 && totalClearedPerYear > 0) {
                    if (netChangeRate > 0) {
                        // Growing waitlist
                        const ratio = totalClearedPerYear / Math.abs(netChangeRate);
                        efficiencyRatio = `${(ratio * 100).toFixed(0)}% of growth`;
                    } else {
                        // Shrinking waitlist
                        efficiencyRatio = 'Clearing faster than growth';
                    }
                } else if (netChangeRate <= 0) {
                    efficiencyRatio = 'Waitlist stable/shrinking';
                }

                // Previous data for trends
                const prevTotal = previous ? parseInt(previous.total_requests) || 0 : null;

                // Market share calculations
                const share22 = formatPercentage(req22, totalRequests);
                const share23 = formatPercentage(req23, totalRequests);
                const share24 = formatPercentage(req24, totalRequests);

                // Find largest demand category
                const demands = [
                    { type: '/22', count: req22, share: share22 },
                    { type: '/23', count: req23, share: share23 },
                    { type: '/24', count: req24, share: share24 }
                ].sort((a, b) => b.count - a.count);

                const largestDemand = demands[0];

                // Update current waitlist
                document.getElementById('current-22').textContent = formatNumber(req22);
                document.getElementById('current-23').textContent = formatNumber(req23);
                document.getElementById('current-24').textContent = formatNumber(req24);
                document.getElementById('total-requests').textContent = formatNumber(totalReq);

                // Update wait times
                document.getElementById('wait-22').textContent = formatYears(wait22) + ' years';
                document.getElementById('wait-23').textContent = formatYears(wait23) + ' years';
                document.getElementById('wait-24').textContent = formatYears(wait24) + ' years';
                document.getElementById('avg-wait').textContent = formatYears(avgWait) + ' years';

                // Update clearing rates
                document.getElementById('cleared-22').textContent = formatNumber(cleared22);
                document.getElementById('cleared-23').textContent = formatNumber(cleared23);
                document.getElementById('cleared-24').textContent = formatNumber(cleared24);
                document.getElementById('total-cleared').textContent = formatNumber(totalCleared);

                // Update network analysis
                document.getElementById('total-24-equiv').textContent = formatNumber(total24Equiv);
                document.getElementById('total-ips').textContent = formatNumber(totalIPs);

                // Update efficiency analysis
                if (mostEfficient) {
                    document.getElementById('most-efficient').textContent =
                        `${mostEfficient.type} (${Math.round(mostEfficient.efficiency)} IPs/yr)`;
                }
                if (leastEfficient) {
                    document.getElementById('least-efficient').textContent =
                        `${leastEfficient.type} (${Math.round(leastEfficient.efficiency)} IPs/yr)`;
                }

                // Update historical context with trends
                const totalTrendHtml = formatNumber(totalReq) + getTrendIndicator(totalReq, prevTotal, true);
                document.getElementById('total-trend').innerHTML = totalTrendHtml;

                document.getElementById('peak-total').textContent =
                    `${formatNumber(peakTotal)} (${peakTotal === totalReq ? 'current' : 'all-time'})`;

                document.getElementById('net-change').textContent = changeText;
                document.getElementById('clearing-efficiency').textContent = efficiencyRatio;

                // Update market share statistics
                document.getElementById('market-22-requests').textContent = share22;
                document.getElementById('market-23-requests').textContent = share23;
                document.getElementById('market-24-requests').textContent = share24;
                document.getElementById('largest-demand').textContent =
                    `${largestDemand.type} (${largestDemand.share})`;

                // Show the statistics section
                document.getElementById('statistics').style.display = 'block';

            } catch (error) {
                console.error('Error updating statistics:', error);
                // Hide statistics section if there's an error
                document.getElementById('statistics').style.display = 'none';
            }
        }

        // Function to update last updated timestamp
        function updateLastUpdated(data) {
            if (data.length === 0) return;

            try {
                // Find the most recent timestamp (data is already sorted by timestamp)
                const mostRecentEntry = data[data.length - 1];
                const timestamp = new Date(mostRecentEntry.timestamp);

                // Format in human-readable format using toLocaleString instead
                const formattedTime = timestamp.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });

                // Update the DOM
                document.getElementById('lastUpdatedTime').textContent = formattedTime;
                document.getElementById('lastUpdated').style.display = 'block';
            } catch (error) {
                console.error('Error updating last updated timestamp:', error);
                // Hide the last updated element if there's an error
                document.getElementById('lastUpdated').style.display = 'none';
            }
        }

        // Load and process data
        async function loadData() {
            try {
                const response = await fetch('waitlist_data.csv');
                if (!response.ok) {
                    throw new Error('Failed to load CSV file');
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    throw new Error('No data found in CSV file');
                }

                // Hide loading, show charts
                document.getElementById('loading').style.display = 'none';
                document.getElementById('charts').style.display = 'block';

                // Update last updated timestamp
                updateLastUpdated(data);

                // Update statistics
                updateStatistics(data);

                // Create charts
                createChart('waitlistChart', 'Current Waitlist Size Over Time', data, {
                    '/22': 'requests_22',
                    '/23': 'requests_23',
                    '/24': 'requests_24'
                }, 'Number of Requests');

                createChart('historicalChart', 'Historical Blocks Cleared Per Quarter', data, {
                    '/22': 'avg_22_cleared_per_quarter',
                    '/23': 'avg_23_cleared_per_quarter',
                    '/24': 'avg_24_cleared_per_quarter'
                }, 'Blocks Per Quarter');

                createChart('waitTimeChart', 'Estimated Wait Time', data, {
                    '/22': 'estimated_years_22',
                    '/23': 'estimated_years_23',
                    '/24': 'estimated_years_24'
                }, 'Years');

                // Create processing capacity chart with calculated total
                createProcessingChart('processedChart', 'Total Processing Capacity Over Time', data);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

    <footer class="footer">
        <p>
            <a href="https://github.com/lanrat/ARIN-IPv4-Waitlist-Tracking" target="_blank">
                üîó View project on GitHub
            </a>
        </p>
    </footer>
</body>
</html>