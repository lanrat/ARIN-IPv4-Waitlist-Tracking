<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARIN IPv4 Waitlist Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            background-color: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
            background-color: #ffebee;
            border-radius: 8px;
            margin: 20px 0;
        }
        .footer {
            text-align: center;
            margin: 40px 0 20px 0;
            padding: 20px;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 14px;
        }
        .footer a {
            color: #007bff;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ARIN IPv4 Waitlist Dashboard</h1>
        <p>Real-time analysis of IPv4 address block waitlist and estimated wait times</p>
    </div>


    <div id="loading" class="loading">
        <h3>Loading data...</h3>
    </div>

    <div id="error" class="error" style="display: none;">
        <h3>Error loading data</h3>
        <p>Could not load waitlist_data.csv. Please ensure the file exists in the same directory.</p>
    </div>

    <div id="charts" style="display: none;">
        <div class="chart-container">
            <h2>Current Waitlist Size</h2>
            <div class="chart-wrapper">
                <canvas id="waitlistChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>Historical Blocks Cleared Per Quarter</h2>
            <div class="chart-wrapper">
                <canvas id="historicalChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>Estimated Wait Time (Years)</h2>
            <div class="chart-wrapper">
                <canvas id="waitTimeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Configuration for chart colors
        const colors = {
            '/22': '#ff6384',
            '/23': '#36a2eb',
            '/24': '#4bc0c0'
        };

        // Function to parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;

                const values = line.split(',').map(v => v.trim());
                if (values.length !== headers.length) continue; // Skip malformed rows

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }

            // Sort data by timestamp to ensure proper chronological order
            data.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return dateA - dateB;
            });

            console.log('Parsed and sorted data:', data); // Debug output
            return data;
        }

        // Function to create chart datasets
        function createDatasets(data, valueColumns, label) {
            const datasets = [];

            Object.keys(colors).forEach(size => {
                const column = valueColumns[size];
                if (column) {
                    const chartData = data.map(row => {
                        const value = parseFloat(row[column]);
                        console.log(`${column} for ${size}: "${row[column]}" -> ${value}`); // Debug output
                        return {
                            x: new Date(row.timestamp),
                            y: isNaN(value) ? 0 : value
                        };
                    });

                    datasets.push({
                        label: `${label} ${size}`,
                        data: chartData,
                        borderColor: colors[size],
                        backgroundColor: colors[size] + '20',
                        tension: 0.1
                    });
                }
            });

            return datasets;
        }

        // Function to create a chart
        function createChart(canvasId, title, data, valueColumns, yAxisLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const datasets = createDatasets(data, valueColumns, '');

            return new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yAxisLabel
                            }
                        }
                    }
                }
            });
        }

        // Load and process data
        async function loadData() {
            try {
                const response = await fetch('waitlist_data.csv');
                if (!response.ok) {
                    throw new Error('Failed to load CSV file');
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    throw new Error('No data found in CSV file');
                }

                // Hide loading, show charts
                document.getElementById('loading').style.display = 'none';
                document.getElementById('charts').style.display = 'block';

                // Create charts
                createChart('waitlistChart', 'Current Waitlist Size Over Time', data, {
                    '/22': 'requests_22',
                    '/23': 'requests_23',
                    '/24': 'requests_24'
                }, 'Number of Requests');

                createChart('historicalChart', 'Historical Blocks Cleared Per Quarter', data, {
                    '/22': 'avg_22_cleared_per_quarter',
                    '/23': 'avg_23_cleared_per_quarter',
                    '/24': 'avg_24_cleared_per_quarter'
                }, 'Blocks Per Quarter');

                createChart('waitTimeChart', 'Estimated Wait Time', data, {
                    '/22': 'estimated_years_22',
                    '/23': 'estimated_years_23',
                    '/24': 'estimated_years_24'
                }, 'Years');

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadData);
    </script>

    <footer class="footer">
        <p>
            <a href="https://github.com/lanrat/ARIN-IPv4-Waitlist-Tracking" target="_blank">
                ðŸ”— View project on GitHub
            </a>
        </p>
    </footer>
</body>
</html>